name: Deploy Next.js to GitHub Pages

on:
  push:
    branches:
      - main # ‡∏´‡∏£‡∏∑‡∏≠ branch ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ
    paths:
      - 'apps/web/**' # ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô apps/web
      - '.github/workflows/deploy.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Node.js (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Prerequisite ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
      - name: üõ†Ô∏è Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô Node.js ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 20 ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤
          node-version: '20' 
          # ... (cache configs)
          cache: 'npm'
          cache-dependency-path: 'apps/web/package-lock.json' # ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ cache ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          # ... (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Setup Node.js)

      - name: üì¶ Install Dependencies
        # ‡πÉ‡∏ä‡πâ npm install ‡πÉ‡∏ô root ‡∏Å‡πà‡∏≠‡∏ô (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà Next.js ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Monorepo)
        run: npm install 

      # ** ‡πÄ‡∏û‡∏¥‡πà‡∏° Step ‡∏ô‡∏µ‡πâ ** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á web ‡πÉ‡∏´‡∏°‡πà
     
      - name: üîÑ Reinstall web dependencies (Fix lightningcss)
        run: npm install 
        working-directory: ./apps/web
        
      # ** ‡πÄ‡∏û‡∏¥‡πà‡∏° Step ‡∏ô‡∏µ‡πâ **
      - name: üßπ Clean Next.js Build Cache
        run: rm -rf .next
        working-directory: ./apps/web

      - name: üèóÔ∏è Build Next.js Static Export
        run: npm run build
        working-directory: ./apps/web

      # ‚û°Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ Build
      - name: üì¶ Install Dependencies
        run: npm install
        working-directory: ./apps/web

      - name: üèóÔ∏è Build Next.js Static Export
        run: npm run build
        working-directory: ./apps/web
      
      # üöÄ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ Deploy
      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main' # deploy ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≤‡∏Å branch ‡∏´‡∏•‡∏±‡∏Å
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Source Directory ‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå 'out' ‡∏ó‡∏µ‡πà Next.js ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å 'output: export'
          publish_dir: ./apps/web/out
          # ‡πÉ‡∏ä‡πâ branch 'gh-pages' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡πÑ‡∏ü‡∏•‡πå
          publish_branch: gh-pages
